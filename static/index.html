<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Codex Cards</title>
	<style>
		:root {
			--bg: #ffffff;
			--panel: #ffffff;
			--text: #111111;
			--muted: #6b7280;
			--line: #d1d5db;
			--accent: #0f766e; /* subdued teal */
			--accent2: #b45309; /* muted orange */
		}
		/* Tufte-inspired typography */
		body { margin: 0; font-family: "Georgia", "Times New Roman", Times, serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
		.container { max-width: 1600px; margin: 0 auto; padding: 32px 40px; }
		h1 { font-weight: 400; letter-spacing: 0.2px; margin: 0 0 16px; font-size: 24px; }
		.controls { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; padding-bottom: 8px; border-bottom: 1px solid var(--line); }
		button { background: transparent; color: var(--text); border: 1px solid #bfbfbf; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-weight: 400; font-family: inherit; }
		button.secondary { border-color: #c8c8c8; color: var(--text); }
		button:hover { background: #f9fafb; }
		button:disabled { opacity: 0.5; cursor: not-allowed; }
		.status { color: var(--muted); font-size: 14px; margin-left: 8px; }
		.cardsWrap { overflow-x: auto; }
		.cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; min-width: 1400px; }
		.card { background: var(--panel); border-radius: 2px; padding: 14px 16px; border: 1px solid var(--line); display: flex; flex-direction: column; }
		.card h3 { margin: 0 0 8px; font-size: 17px; font-weight: 400; }
		.card .category { color: var(--muted); font-size: 12px; margin-bottom: 10px; letter-spacing: 0.4px; text-transform: uppercase; }
		.card .text { white-space: pre-wrap; line-height: 1.5; flex: 1 1 auto; font-size: 15px; }
		.card .actions { margin-top: 12px; }
		.footer { margin-top: 18px; color: var(--muted); font-size: 12px; display: flex; gap: 12px; align-items: center; border-top: 1px solid var(--line); padding-top: 8px; }
		.footer a { color: var(--accent); text-decoration: none; }
		.footer a:hover { text-decoration: underline; }
	</style>
</head>
<body>
	<div class="container">
		<h1>Re-enlightening Cards</h1>
		<div class="controls">
			<button id="drawBtn" disabled>Draw card</button>
			<button id="resetBtn" disabled>Reset deck</button>
			<div class="status" id="status">Connecting…</div>
		</div>
		<div class="cardsWrap">
			<div class="cards" id="cards"></div>
		</div>
		<div class="footer">
			<span>All players see the same draws in real time.</span>
			<a href="/instructions">Download instructions (.docx)</a>
			<span>·</span>
			<a href="/cards">Download cards.json</a>
		</div>
	</div>

	<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
	<script>
		const drawBtn = document.getElementById('drawBtn');
		const resetBtn = document.getElementById('resetBtn');
		const statusEl = document.getElementById('status');
		const cardsEl = document.getElementById('cards');

		function escapeHtml(str) {
			return (str || '').replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s]));
		}

		function setConnected(connected) {
			drawBtn.disabled = !connected;
			resetBtn.disabled = !connected;
			statusEl.textContent = connected ? 'Connected' : 'Disconnected';
		}

		function getSuit(card) {
			const c1 = (card.Category1 || '').toUpperCase();
			const c2 = (card.Category2 || '').toUpperCase();
			const suits = ['TOUCHSTONE','WORKSHOP','TOOL','PROTOCOL','PLATFORM'];
			if (suits.includes(c1)) return c1;
			if (suits.includes(c2)) return c2;
			return '';
		}

		function render(state) {
			statusEl.textContent = `${state.drawn.length} drawn / ${state.total} total / ${state.remaining} remaining`;
			drawBtn.disabled = state.remaining <= 0;
			cardsEl.innerHTML = '';
			const can = state.canRedraw || {};
			for (const card of state.drawn) {
				const el = document.createElement('div');
				el.className = 'card';
				const name = card.Name || 'Card';
				const c1 = card.Category1 || '';
				const c2 = card.Category2 || '';
				const suit = getSuit(card);
				const text = (card.Text || card.ShortText || '').replaceAll('\u2022', '•');
				el.innerHTML = `
					<div class="category">${escapeHtml(c1)}${c1 && c2 ? ' · ' : ''}${escapeHtml(c2)}</div>
					<h3>${escapeHtml(name)}</h3>
					<div class="text">${escapeHtml(text)}</div>
				`;
				if (suit && (suit === 'WORKSHOP' || suit === 'TOOL' || suit === 'PROTOCOL')) {
					const actions = document.createElement('div');
					actions.className = 'actions';
					const btn = document.createElement('button');
					btn.className = 'secondary';
					btn.textContent = `Redraw ${suit.charAt(0)}${suit.slice(1).toLowerCase()}`;
					btn.disabled = !can[suit];
					btn.addEventListener('click', () => socket.emit('redraw', { suit }));
					actions.appendChild(btn);
					el.appendChild(actions);
				}
				cardsEl.appendChild(el);
			}
		}

		const socket = io({ transports: ['websocket', 'polling'] });
		socket.on('connect', () => { setConnected(true); });
		socket.on('disconnect', () => { setConnected(false); });
		socket.on('connect_error', () => { statusEl.textContent = 'Connection error'; });
		socket.on('state', (state) => { render(state); });

		drawBtn.addEventListener('click', () => socket.emit('draw'));
		resetBtn.addEventListener('click', () => socket.emit('reset'));
	</script>
</body>
</html>
